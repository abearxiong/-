<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Https加密和Apache反向代理问题! | Abear</title>
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="Https加密和Apache反向代理问题!" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="DigitalOcean VPS 加密服务器为HTTPS和反向代理" />
<meta property="og:description" content="DigitalOcean VPS 加密服务器为HTTPS和反向代理" />
<link rel="canonical" href="http://localhost:4000/ubuntu/2018/10/03/install-https-for-vps.html" />
<meta property="og:url" content="http://localhost:4000/ubuntu/2018/10/03/install-https-for-vps.html" />
<meta property="og:site_name" content="Abear" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-10-03T08:06:57-07:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/ubuntu/2018/10/03/install-https-for-vps.html"},"url":"http://localhost:4000/ubuntu/2018/10/03/install-https-for-vps.html","headline":"Https加密和Apache反向代理问题!","dateModified":"2018-10-03T08:06:57-07:00","datePublished":"2018-10-03T08:06:57-07:00","description":"DigitalOcean VPS 加密服务器为HTTPS和反向代理","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Abear" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Abear</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Https加密和Apache反向代理问题!</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2018-10-03T08:06:57-07:00" itemprop="datePublished">Oct 3, 2018
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h1 id="digitalocean-vps-加密服务器为https和反向代理">DigitalOcean VPS 加密服务器为HTTPS和反向代理</h1>

<blockquote>
  <p>因为有一些Token，登陆模块，想只放在一个自己常用的服务器，然后就使用了nodejs来作为一个登陆模块。在面对Microsoft outlook OAuth的时候发现一个问题，他的回调函数必须是https的样式的。于是，自己去找办法设置自己的网站的http进行加密。</p>
</blockquote>

<p><em>很多是网上找到的，自己只记下自己成功的步骤，不对过程做更多了解。</em></p>

<p><em>在这过程自己去gandi网站买了个6元的域名，gnoixiong.qw；修改为了digitalOcean的dns，发现需要很久才能更新成功，可以访问。修改为DigitalOcean的DNS是为了测试他自带的均衡加载，最后弄了快差不多的时候发现需要每个月10美元，放弃。</em></p>
<h2 id="digitalocean-vps-http-加密ubuntu170使用lets-encrypt">DigitalOcean VPS http 加密（Ubuntu17.0）<strong>使用Let’s Encrypt</strong></h2>
<blockquote>
  <p>第一次是Google到的，但是最后遇到的问题是不支持什么的错误，而且根据官网的解决办法无效，记得是<code class="highlighter-rouge">sudo certbot --authenticator standalone --installer apache -d www.gnoixiong.pw --pre-hook "service apache stop" --post-hook "service apache start"
</code>，2019年1月什么之前。[此刻时间2018.10.2]</p>
</blockquote>

<h3 id="根据url成功">根据<a href="https://devanswers.co/lets-encrypt-ssl-apache-ubuntu-18-04/">url</a>成功</h3>
<ol>
  <li><code class="highlighter-rouge">sudo add-apt-repository ppa:certbot/certbot</code></li>
  <li>输入Enter</li>
  <li><code class="highlighter-rouge">sudo apt update</code></li>
  <li><code class="highlighter-rouge">sudo apt install python-certbot-apache</code></li>
</ol>

<p><img src="https://res.cloudinary.com/xiongxiao/image/upload/v1538577134/github/images/2018-10-03-01.png" alt="图1" /></p>

<ol>
  <li><code class="highlighter-rouge">y</code>+<code class="highlighter-rouge">Enter</code></li>
  <li><code class="highlighter-rouge">suto certbot --apache -d gnoixiong.pw -d www.gnoixiong.pw
xiongxiao1012@outlook.com</code></li>
  <li><code class="highlighter-rouge">a</code>+<code class="highlighter-rouge">Enter</code></li>
</ol>

<p><img src="https://res.cloudinary.com/xiongxiao/image/upload/v1538577134/github/images/2018-10-03-02.png" alt="图2" /></p>

<ol>
  <li><code class="highlighter-rouge">n</code></li>
</ol>

<p><img src="https://res.cloudinary.com/xiongxiao/image/upload/v1538577134/github/images/2018-10-03-03.png" alt="图3" /></p>

<ol>
  <li>检测是否成功</li>
</ol>

<p><img src="https://res.cloudinary.com/xiongxiao/image/upload/v1538577134/github/images/2018-10-03-04.png" alt="图4" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>如图类似的URL去检测
https://www.ssllabs.com/ssltest/analyze.html?d=www.gnoixiong.pw
https://www.ssllabs.com/ssltest/analyze.html?d=gnoixiong.pw
</code></pre></div></div>
<ol>
  <li><code class="highlighter-rouge">sudo certbot renew --dry-run</code> 执行自动申请证书</li>
</ol>

<h2 id="反向代理问题">反向代理问题</h2>
<blockquote>
  <p>当我的https弄好后，发现Microsoft需要https才行，而我弄好的只是php的，nodejs的3000端口还是http接口。所以需要反向代理，之前玩微信小程序的时候知道NGINX可以反向代理，而去了解资料知道Apache同样可以，并通过一系列查资料成功完成。</p>
</blockquote>

<p><img src="https://res.cloudinary.com/xiongxiao/image/upload/v1538577134/github/images/2018-10-03-05.png" alt="图5" /></p>

<h3 id="过程">过程</h3>

<ol>
  <li>加载apache模块，使用a2enmod命令加载模块</li>
  <li>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a2enmod proxy proxy_balancer proxy_http
</code></pre></div>    </div>
  </li>
  <li>配置反向代理功能，进入sites_available(Ubuntu /etc/apache2/sites_available)，创建一个新的站点配置文件(新建文件），然后编辑内容如下：</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;VirtualHost *:80&gt;
        #配置站点的域名
        ServerName xxx.com
        #off表示开启反向代理，on表示开启正向代理
        ProxyRequests Off
        ProxyMaxForwards 100
        ProxyPreserveHost On
        ProxyPass / http://127.0.0.1:3000/
        ProxyPassReverse / http://127.0.0.1:3000/
        &lt;Proxy *&gt;
            Order Deny,Allow
            Allow from all
        &lt;/Proxy&gt;
&lt;/VirtualHost&gt;
</code></pre></div></div>

<ol>
  <li><code class="highlighter-rouge">a2ensite</code>加载刚才那个文件，然后 <code class="highlighter-rouge">systemctl restart apache2</code>  重启,即可。</li>
</ol>

<h3 id="https的有东西">https的有东西</h3>
<blockquote>
  <p>在之前的http是可以已经算是完成了，然后代理也没毛病，然后却发现一个大的问题，https不行，仍旧是之前的443端口，而且没有代理。Google了一会，然后自己慢慢摸索已经是好的配置，关于443的配置。</p>
</blockquote>

<ol>
  <li>重复修改已经有的443的那个配置文件，发现一直不能成功。</li>
  <li>根据已经有的配置文件，复制出来，创建一个新的文件，通过<code class="highlighter-rouge">a2ensite</code> 加载新的文件，等于默认一个域名，代理一个域名，后成功。</li>
</ol>

<p><strong><em>配置文件在最下</em></strong></p>

<p>参考文献:
    简书<a href="https://www.jianshu.com/p/47eca94680aa">zhengyu4767</a> |
    CSDN<a href="https://blog.csdn.net/aerchi/article/details/73605496">乐意黎</a> |
    自己对已经好的配置的理解，保存之前配置好的文件，很重要。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#关于HTTPS的配置文件
&lt;IfModule mod_ssl.c&gt;
&lt;VirtualHost *:443&gt;
ServerName www.gnoixiong.pw
DocumentRoot /var/www/LoginApi
SSLEngine On
Include /etc/letsencrypt/options-ssl-apache.conf
#ServerAlias www.gnoixiong.pw
SSLCertificateFile /etc/letsencrypt/live/gnoixiong.pw/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/gnoixiong.pw/privkey.pem

ProxyRequests Off
ProxyMaxForwards 100
ProxyPreserveHost On
ProxyPass / http://127.0.0.1:3000/
ProxyPassReverse / http://127.0.0.1:3000/
&lt;Proxy *&gt;
        Order Deny,Allow
        Allow from all
&lt;/Proxy&gt;

&lt;/VirtualHost&gt;
&lt;/IfModule&gt;

#关于HTTP的配置文件

&lt;VirtualHost *:80&gt;
        #配置站点的域名
        ServerName gnoixxiong.pw
        #配置站点的管理员信息
        ServerAdmin xiongxiao1012@outlook.com

        #off表示开启反向代理，on表示开启正向代理
        ProxyRequests Off
        ProxyMaxForwards 100
        ProxyPreserveHost On
        #这里表示要将现在这个虚拟主机跳转到本机的4000端口
        ProxyPass /var/www/LoginApi  http://127.0.0.1:3000/
        ProxyPassReverse /var/www/LoginApi http://127.0.0.1:3000/

        &lt;Proxy *&gt;
            Order Deny,Allow
            Allow from all
        &lt;/Proxy&gt;

&lt;/VirtualHost&gt;        
</code></pre></div></div>


  </div><a class="u-url" href="/ubuntu/2018/10/03/install-https-for-vps.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Abear</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Abear</li><li><a class="u-email" href="mailto:xiongxiao1012@outlook.com">xiongxiao1012@outlook.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/abearxiong"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">abearxiong</span></a></li><li><a href="https://www.twitter.com/abear"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">abear</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>每一天都是一个新的开始，今天与明天最大的不同，今天我还活着，明天却毫无感觉。所以时刻注重今天的美好时光，写好代码，玩好，IT男。</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
