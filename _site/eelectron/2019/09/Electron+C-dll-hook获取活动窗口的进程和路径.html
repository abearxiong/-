<!DOCTYPE html>
<html lang="zh">
  <head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.0 -->
<title>Electron C# dll hook获取活动窗口的进程和路径 | Abear</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Electron C# dll hook获取活动窗口的进程和路径" />
<meta name="author" content="abearxiong" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Electron 抓取底层的系统信息。获取活动窗口的进程名，进程id和路径位置。主要使用Electron,electron-edge-js，C#生成库文件。" />
<meta property="og:description" content="Electron 抓取底层的系统信息。获取活动窗口的进程名，进程id和路径位置。主要使用Electron,electron-edge-js，C#生成库文件。" />
<link rel="canonical" href="http://0.0.0.0:4000/eelectron/2019/09/Electron+C-dll-hook%E8%8E%B7%E5%8F%96%E6%B4%BB%E5%8A%A8%E7%AA%97%E5%8F%A3%E7%9A%84%E8%BF%9B%E7%A8%8B%E5%92%8C%E8%B7%AF%E5%BE%84.html" />
<meta property="og:url" content="http://0.0.0.0:4000/eelectron/2019/09/Electron+C-dll-hook%E8%8E%B7%E5%8F%96%E6%B4%BB%E5%8A%A8%E7%AA%97%E5%8F%A3%E7%9A%84%E8%BF%9B%E7%A8%8B%E5%92%8C%E8%B7%AF%E5%BE%84.html" />
<meta property="og:site_name" content="Abear" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-09-15T15:57:52+08:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Electron C# dll hook获取活动窗口的进程和路径","url":"http://0.0.0.0:4000/eelectron/2019/09/Electron+C-dll-hook%E8%8E%B7%E5%8F%96%E6%B4%BB%E5%8A%A8%E7%AA%97%E5%8F%A3%E7%9A%84%E8%BF%9B%E7%A8%8B%E5%92%8C%E8%B7%AF%E5%BE%84.html","dateModified":"2019-09-15T15:57:52+08:00","datePublished":"2019-09-15T15:57:52+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/eelectron/2019/09/Electron+C-dll-hook%E8%8E%B7%E5%8F%96%E6%B4%BB%E5%8A%A8%E7%AA%97%E5%8F%A3%E7%9A%84%E8%BF%9B%E7%A8%8B%E5%92%8C%E8%B7%AF%E5%BE%84.html"},"author":{"@type":"Person","name":"abearxiong"},"description":"Electron 抓取底层的系统信息。获取活动窗口的进程名，进程id和路径位置。主要使用Electron,electron-edge-js，C#生成库文件。","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<!-- cdn -->  <!-- bootstrap -->
<link href="https://cdn.bootcss.com/twitter-bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/feed.xml" title="Abear" />
  </head>
  <body>  <div class="header-wraper">
      <header class="Header">
        <div class="Header-item">
          <a class="Header-link" href="/">
            <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1" width="32" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
          </a>
        </div>
        <div class="Header-item"><input type="text"  /></div>
        <div class="Header-item">
          <a class="Header-link" href="/article">文章</a>
          <a class="Header-link" href="/space">空间</a>
          <a class="Header-link" href="/draft">草稿</a>
          <a class="Header-link" href="/project">计划</a>
          <a class="Header-link" href="/feed.xml">RSS</a>
          <a class="Header-link" href="/lolChessHelper/">L自走棋</a>
        </div>
      </header>
  </div><div class="container">
      <div class="home">
  <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <header class="post-header">
      <h1 class="post-title p-name" itemprop="name headline">Electron C# dll hook获取活动窗口的进程和路径</h1>
      <p class="post-meta">
        <time class="dt-published" datetime="2019-09-15T15:57:52+08:00" itemprop="datePublished">Sep 15, 2019
        </time></p>
    </header>

    <div class="post-content e-content" itemprop="articleBody">
      <p>在实现这个要求前，需要有node-gyp，node-gyp需要有python2.7,visual studio2015的什么动态链接库。为了简便方法的安装，我安装的的方法是直接安装windows-build-tools的包。</p>

<h2 id="windows的环境">Windows的环境</h2>

<h3 id="1-安装gyp">1. 安装gyp</h3>
<pre><code class="language-npm">npm i -g node-gyp
</code></pre>

<h3 id="2-安装扩展包">2. 安装扩展包</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install --global --production windows-build-tools
</code></pre></div></div>

<h3 id="3-配置python路径">3. 配置python路径</h3>

<p>路径的位置是在系统用户的文件夹下的.windows-build-tools里面。c:/user/用户/.windows-build-tools</p>

<pre><code class="language-node">node-gyp python --python /path/to/python27
</code></pre>

<h2 id="安装electron">安装Electron</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm i -g electron@latest
</code></pre></div></div>

<h3 id="1-建立工程">1. 建立工程</h3>

<pre><code class="language-npm">mkdir electron-demo
npm init
npm i electron
npm i electron-edge-js
</code></pre>

<h3 id="2-初始化indexhtml和indexjs">2. 初始化<code class="highlighter-rouge">index.html</code>和<code class="highlighter-rouge">index.js</code></h3>

<p>index.html</p>
<pre><code class="language-HTML">&lt;!DOCTYPE html&gt;
&lt;html&gt;&lt;head&gt;&lt;/head&gt;
&lt;body&gt;
   测试&lt;input type="text" /&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p><code class="highlighter-rouge">index.js</code></p>
<pre><code class="language-JS">const { app,BrowserWindow } = require('electron')
var edge = require('electron-edge-js')
// let createWindow =  () =&gt;{
//     let win = new BrowserWindow ({
//         nodeIntegration: true
//     })
//     win.loadFile("index.html")
//     console.log("启动",Number.parseInt('256')) //发现的程序内的hook
//     win.hookWindowMessage(Number.parseInt('256'),( wParm, lParm)=&gt;{
//         let eventName = null
//         console.log(wParm,"参数")
//     }) //Number.parseInt('0xD')
//     let isHook = win.isWindowMessageHooked(Number.parseInt('256'))
//     console.log(isHook)
//     let fileName = win.getRepresentedFilename()
// }

let createWindow = () =&gt; {
    let win = new BrowserWindow({
        nodeIntegration: true
    })
    win.loadFile("index.html") // 加载HTML
    console.log("启动")
    let HelloDll = edge.func({
        assemblyFile: 'winkey.dll',
        typeName: 'winkey.GetActivity',
        methodName: 'HelloDll'
    }) // 测试DLL
    let HookStart = edge.func({
        assemblyFile: 'winkey.dll',
        typeName: 'winkey.GetActivity',
        methodName: 'HookStart'
    }) // 开始进程
    let GetData = edge.func({
        assemblyFile: 'winkey.dll',
        typeName: 'winkey.GetActivity',
        methodName: 'GetData'
    }) // 获取进程的变量
    HelloDll(1, 2, function (err, result) {
        if (err) {
            console.log("err", err)
        } else {
            console.log("result", result)
        }

    })
    HookStart(1,function(err,result){
        if (err) {
            console.log("err", err)
        } else {
            console.log("HookStart result", result)
        }
    })
    setInterval(() =&gt; {
       GetData(1,function(err,result){
        if (err) {
            console.log("err", err)
        } else {
            console.log("result", result)
        }
       })
    }, 2000);   // 每隔两秒进行打印所激活窗口的一些值，进程名字，进程ID，进程的路径

}

app.on('ready', createWindow)
</code></pre>

<h3 id="3-c-创建dll建立hook窗口的程序">3. C# 创建DLL，建立Hook窗口的程序</h3>

<ol>
  <li>使用Visual Studio创建工程</li>
</ol>

<p>新建，选择类库（.Net FrameWork),自己创建自己的工程，我创建的是winkey,修改文件名类的名字GetActivity,和Electron的对应。</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Runtime.InteropServices;
using System.Text;
using System.Threading.Tasks;
using System.Windows;


namespace winkey
{
    public class GetActivity
    {
        private System.Threading.Timer threadTimer;
        private Process myProcess;
        volatile public static String Data ="内容";
        public async Task&lt;object&gt; HelloDll(object input)
        {
            Console.WriteLine("输入HelloDLL");
            Console.WriteLine(input);
            return "helloDll";
        }
        public async Task&lt;object&gt; GetData(object input)
        {
            Console.WriteLine("Data---"+ GetActivity.Data);
            return GetActivity.Data;
        }
        public async Task&lt;object&gt; HookStart(object input)
        {
            threadTimer = new System.Threading.Timer(new System.Threading.TimerCallback(GetValue), null, 0, 2000);
            return "start";
        }
        public async Task&lt;object&gt; HookEnd(object input)
        {
            threadTimer.Dispose();
            return "0";
        }
        [DllImport("User32.dll")]
        public static extern IntPtr GetForegroundWindow(); //获取活动窗口句柄

        [DllImport("User32.dll")]
        public static extern int GetWindowThreadProcessId(IntPtr hwnd, out int ID); //获取线程ID

        /// &lt;summary&gt;
        /// 获取进程的内容
        /// &lt;/summary&gt;
        /// &lt;param name="state"&gt;&lt;/param&gt;
        private void GetValue(Object state)
        {
            //Thread.Sleep(3000);    //睡眠3s，用来选择活动窗口
            IntPtr hWnd = GetForegroundWindow();    //获取活动窗口句柄
            int calcID = 0;    //进程ID
            int calcTD = 0;    //线程ID
            calcTD = GetWindowThreadProcessId(hWnd, out calcID);
            myProcess = Process.GetProcessById(calcID);
            String getInfo;
            try
            {
                getInfo = "进程名：" + myProcess.ProcessName + "\n" + "进程ID：" + calcID + "\n" + "程序路径：" + myProcess.MainModule.FileName;
                //Console.WriteLine(getInfo);  //在MessageBox中显示获取的信息
                GetActivity.Data = getInfo;
            }
            catch
            {
                getInfo = "程序不能读取路径" + "进程名：" + myProcess.ProcessName + "\n" + "进程ID：" + calcID + "\n"; // 不能获取类似于cmd的路径，所以就try catch
                //Console.WriteLine(getInfo);
                GetActivity.Data = getInfo;
            }

        }
    }
}


</code></pre></div></div>

<ol>
  <li>生成DLL文件</li>
</ol>

<p>在自己的bin/debug里面</p>

<ol>
  <li>
    <p>复制到Electron的根目录，根据自己Electron读取的路径进行自定义</p>
  </li>
  <li>
    <p>在Electron的路径运行 <code class="highlighter-rouge">electron . </code> 因为安装了全局的electron，所以直接运行就好了。</p>
  </li>
</ol>

<p>执行的结果如图 electron-hook.gif</p>

<p><img src="https://res.cloudinary.com/xiongxiao/image/upload/v1568537455/github/images/electron-hook.gif" alt="elctron-hook" /></p>

<p><a href="https://github.com/abearxiong/databank/blob/master/Super%20Desktop/electron-hook-demo.zip">代码地址</a></p>

    </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

<div id="gitalk-container"></div>

<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script>
    const gitalk = new Gitalk({
        clientID: 'd209733bda586b697c41',
        clientSecret: 'efd35ea6ff910b44fb9fbbc29d6ec8240ac196a2',
        repo: 'reviews',
        owner: 'abearxiong',
        admin: ['abearxiong'],
        id: location.pathname,      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
    })
    gitalk.render('gitalk-container')
</script>
<a class="u-url" href="/eelectron/2019/09/Electron+C-dll-hook%E8%8E%B7%E5%8F%96%E6%B4%BB%E5%8A%A8%E7%AA%97%E5%8F%A3%E7%9A%84%E8%BF%9B%E7%A8%8B%E5%92%8C%E8%B7%AF%E5%BE%84.html" hidden></a>
  </article>
</div>
    </div><div class="footer">

</div><!--Bootstrap js-->
<script src="/assets/js/jquery-3.3.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://cdn.bootcss.com/twitter-bootstrap/4.1.3/js/bootstrap.min.js"></script>
<!-- Script -->
<script src="/assets/js/main.js"></script>

  </body>

</html>